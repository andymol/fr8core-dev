# Terminal discovery

Some important notes before actual explanations. Currently we have the following expectations:
* More than one Hub can exist.
* Each terminal can work with several Hubs.
* Terminal endpoints are public. That means everyone can access them without any restrictions.
* Hub endpoints are secured. No one can access them without authentication.
* Users has ability to register new terminals in Hub dynamically (without re-compiling/restarting the Hub)

## Discovery subsystem

During the startup Hub calls **/discover** endpoint for each registered terminal. During discovery Hub generates secret for the terminal and update list of activities. 

When terminal receives **/discover** request it adds information about the Hub that issued this request in the list of registered hubs non-volatile memory. This list can be used by monitoring activities to broadcast events to every registered Hub. What is non-volatile memory in this case? Currently we are using **Warehouse** of one of the Hubs as the persistent storage. hub, whose Warehouse is used to store data is called **Master Hub**. URL for Master Hub is stored within configuration file of the terminal. This is the only hard-coded information about Hub that is stored in the terminal. When the terminal boots, it queries **Warehouse** from the **Master Hub** for the list of Hubs that are registered within the terminal and caches this list in-memory to speed up event broadcasting.

## Secrets issuing subystem

Hub should protect data from unauthorized access. Both Web Client and terminals should authorize to Hub before performing actual operations. Terminals are authorized by means of Secrets. Secret is some random string that is assigned for each terminal registered within the Hub. Hub is solely responsible for the Secret assignment and generation. Hub generate the secret during discovering the terminal and persist generated secret in Terminals table. Lets see, how terminal can become aware of the secret generated by the Hub. There are two possible scenarios:

### Hub is initiating the request to the terminal. 
In this case Hub will send the secret within HTTP headers for this request. There are two headers that contain this information:
* **Fr8HubCallbackSecret** - the secret itself
* **Fr8HubCallBackUrl** - URL of the Hub that issued the secret

Terminal should store received secret and use this secret whenever terminal is going to make requests to the Hub at **Fr8HubCallBackUrl**. **Fr8HubCallBackUrl** has another important role. Suppose your activity has received configuration request. During this request you are going to create some child activities or get some data from Warehouse. Do you remember that terminal can work with more than one Hub? So without some context, your activity can't decide what Hub should be used for adding child activities. If you request the wrong (not the Hub that issued the request you activity is currently processing) Hub you are likely to receive an error. This when **Fr8HubCallBackUrl** comes to help. Activity can use URL from this header to decide which Hub to use during processing current request.

### Terminal is initiating requests to the Hub.

This can happen if your are writing monitoring activity and this activity received external event. In some cases (for example Hub hasn't manged to call **/discover** endpoint for your terminal) your terminal is unaware of secret for this Hub. In this case terminal should request the Hub to call this terminal's **/discover** endpoint. Hub's endpoint responsible for this is the only unsecured endpoint. Everyone can request to call **/forceDiscovery** Hub endpoint and pass desired endpoint. Hub is smart. Before issuing any requests back to the terminal it will check if the URL passed belongs to the terminals registered within this Hub. If not, Hub will respond with error. Otherwise Hub initiate terminal discovery procedure. Terminal should postpone requests to this Hub until it receives the secret withing **/discover** request.